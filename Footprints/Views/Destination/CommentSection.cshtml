@using Microsoft.AspNet.Identity
@using Footprints.Common
@model IEnumerable<Footprints.ViewModels.CommentViewModel>
<script type="text/javascript">
    //get data from callback and insert html
    function addComment(data) {
        var target = $("#comment-section-container");
        for (var i = 0; i < data.length; i++) {
            var comment = data[i];
            target.before(
                '<li class="list-group-item">'
                + '	<img src="' + comment.UserAvatarURL + '" alt="Avatar" class="pull-left" width="36" height="36" />'
                + '	<div class="user-info">'
                + '		<div class="row">'
                + '			<div class="col-md-3">'
                + '				<a href="">' + comment.UserCommentName + '</a>'
                + '				<abbr>' + comment.TimeAgo + '</abbr>'
                + '			</div>'
                + '			<div class="col-md-9">'
                + '				<span> ' + comment.Content + '</span>'
                + '			</div>'
                + '		</div>'
                + '	</div>'
                + '</li>'
                );
        }
    }
    //Edit comment callback function
    function editComment(data) {
        if (data != null && data.length > 0) {
            var commentObj = data[0];
            var commentContent = $("#comment-content-" + commentObj.CommentID);
            commentContent.find('span').text(commentObj.Content);
            commentContent.show();
            var commentEdit = $("#comment-edit-" + commentObj.CommentID);
            var commentEditTextarea = commentEdit.find('form').find('textarea[name="Content"]');
            commentEditTextarea.text(commentObj.Content);
            commentEditTextarea.val(commentObj.Content);
            commentEdit.hide();
        }
    }
    function validateAddCommentForm(destinationId) {
        var form = $('#add-comment-form-' + destinationId);
        if (form == null)
            return false;
        else {
            var txtContent = form.find('textarea');
            if (txtContent == null || txtContent.val() == null || txtContent.val().trim().length == 0)
                return false;
            else
                return true;
        }
    }
</script>
<div class="row">
    <div class="col-md-12 col-sm-8">
        <ul class="list-group social-comments margin-none">
            @foreach (var comment in Model)
            {
                <li class="list-group-item" id="comment-item-@comment.CommentID">
                    @if (StringUtil.compareGuidToString(comment.UserCommentId, User.Identity.GetUserId()))
                    {
                        <div class="icon-edit pull-right" style="position:absolute; top:8px;right:8px; z-index:1">
                            <div class="dropdown">
                                <a href="#" data-toggle="dropdown"><i class="glyphicon glyphicon-pencil"></i></a>
                                <ul aria-labelledby="dLabel" role="menu" class="dropdown-menu" style="white-space:nowrap">
                                    <li><a onclick="javascript:SetupEditCommentForm.showEditCommentArea('@comment.CommentID');">Edit...</a></li>
                                    <li><a onclick="javascript:SetupDeleteCommentForm.displayPopUpWindow('@comment.CommentID');">Delete...</a></li>
                                </ul>
                            </div>
                        </div>
                    }

                    <img src="@comment.UserAvatarURL" alt="Avatar" class="pull-left" width="36" height="36" />
                    <div class="user-info">
                        <div class="row">
                            <div class="col-md-3">
                                <a href="">@comment.UserCommentName</a>
                                <abbr>@comment.TimeAgo</abbr>
                            </div>
                            <div class="col-md-9" id="comment-content-@comment.CommentID">
                                <span>@comment.Content</span>
                            </div>
                            @* Authenticate to display edit comment menu *@
                            @if (StringUtil.compareGuidToString(comment.UserCommentId, User.Identity.GetUserId()))
                            {
                                Html.RenderPartial("EditCommentForm", comment);
                            }
                        </div>
                    </div>
                </li>
            }
            @if (@User.Identity.IsAuthenticated)
            {
                <li class="list-group-item innerAll" id="comment-section-container">
                    @using (Ajax.BeginForm("Comment", new { controller = "Destination" }, new AjaxOptions { HttpMethod = "POST", OnSuccess = "addComment", OnBegin = "return validateAddCommentForm('" + @ViewBag.DestinationID + "');" }, new { id = "add-comment-form-" + ViewBag.DestinationID }))
                    {
                        @Html.AntiForgeryToken()
                        @Html.Hidden("DestinationID", (object)ViewBag.DestinationID)

                        <div class="form-group">
                            @Html.TextArea("Content", null, new { name = "message", id = "comment-input-" + @ViewBag.DestinationID, @class = "form-control input-sm autoheight", placeholder = "Comment here ...", rows = "1", style = "resize:none;" })
                            <input type="submit" class="btn btn-xs btn-primary pull-right" value="Done" />
                        </div>
                    }
                </li>
            }
        </ul>
    </div>
</div>
<script src="~/assets/plugins/forms_elements_textarea/jquery.elastic.js"></script>
<script type="text/javascript">
    //Check for keyup Esc on edit comment field
    $('[id^="comment-edit-"]').keyup(function (ev) {
        if (ev.which == 27) {
            $(this).hide();
            var commentContent = $("#comment-content-" + $(this).attr('id').replace('comment-edit-', ''));
            commentContent.show();
            $(this).find('form textarea').text(commentContent.find('span').text());
            $(this).find('textarea').val($(this).find('textarea').text());
        }
    });
    var SetupEditCommentForm = (function () {
        return {
            init: function () {
            },
            showEditCommentArea: function (CommentID) {
                var commentContentList = $('div[id^="comment-content-"]');
                commentContentList.each(function () {
                    $(this).show();
                });
                var commentEditList = $('div[id^="comment-edit-"]');
                commentEditList.each(function () {
                    $(this).hide();
                });
                var commentContent = $('#comment-content-' + CommentID)
                commentContent.hide();
                var commentEdit = $('#comment-edit-' + CommentID);
                commentEdit.show();
            }
        };
    })();
    //Check unchanged comment content
    $('form[name="frmEditComment"]').submit(function () {
        var txtComment = $(this).find('textarea');
        if (txtComment.val() == txtComment.text().trim()) {
            return false;
        }
    });
    $(function () {
        SetupEditCommentForm.init();
        $('.autoheight').elastic();
    });
</script>
